---
title: "A3 - Modelización predictiva"
author: "Autor: Morten Nyborg"
date: "Deciembre 2021"
output:
  html_document:
    highlight: default
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_depth: 2
  word_document: default
  pdf_document:
    highlight: zenburn
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
if(!require(dplyr)){
    install.packages('dplyr',repos='http://cran.es.r-project.org')
    require(dplyr)
}
if(!require(faraway)){
    install.packages('faraway',repos='http://cran.es.r-project.org')
    require(faraway)
}
if(!require(ggplot2)){
    install.packages('ggplot2',repos='http://cran.es.r-project.org')
    require(ggplot2)
}
if(!require(ggcorrplot)){
    install.packages('ggcorrplot',repos='http://cran.es.r-project.org')
    require(ggcorrplot)
}
if(!require(sjPlot)){
    install.packages('sjPlot',repos='http://cran.es.r-project.org')
    require(sjPlot)
}
if(!require(ResourceSelection)){
    install.packages('ResourceSelection',repos='http://cran.es.r-project.org')
    require(ResourceSelection)
}
if(!require(pROC)){
    install.packages('pROC',repos='http://cran.es.r-project.org')
    require(pROC)
}

```

# Regresión lineal  

Primero cargamos el dataset. Podemos ver que el dataset tiene 7464 filas y 23 columnas.  
```{r echo=TRUE, message=FALSE, warning=FALSE}
# Loading data
air <- read.csv('./dat_air.csv', header = TRUE, sep = ",")

# Dimension of dataset.
dim(air)

# Columns in dataset
colnames(air)

```
Para facilitar los cálculos vamos a omitir los valores NA. 

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Remove na.
air <- na.omit(air)
# Verify they are removed.
any(is.na(air))

```
  

## Estudio de correlación lineal  
**Se pide calcularla matriz de correlación entre las variables siguientes: Contaminantes: O3, NO2 y PM10, junto con las variables metereológicas: Tmp, HR, RS, Vel y Dir.**  
  
**a) ¿Cual de los contaminantes atmosféricos citados anteriormente, tienen una mayor relación lineal con la RS? Interpretar las relaciones de dicho contaminante con la RS y también con el resto de variables metereológicas**  


Guardamos las variables que se piden en el enunciado.  

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Save the variables to be used.
correlation.variables <- c("O3", "NO2", "PM10", "Tmp", "HR", "RS", "Vel", "Dir_Aire")


```


Creamos la matriz de correlaciones usando un mapa de calor. 

O3, ozono tiene una correlación positiva con RS, con Tmp y Vel y correlación negativa con HR y Dir_Aire. El aumento del ozono está relacionado positivamente con el aumento de la radiación solar, la temperatura y con la velocidad del aire y relacionado negativamente con el nivel de humedad y la dirección del aire.  
  
N02, relacionado positivamente con Dir_Aire, la correlación es debil. Correlacion negativa más debil que en caso de O3 con Tmp y Vel. Las correlaciones con las otras variables meteorológicas es debil.  
  
PM10 tiene correlación negativa con Tmp y Vel, las correlaciones son incluso más débiles que para las otras dos variables. Las correlaciones positivas son débiles.  

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Calculate the correlation matrix for selected variables.
cor.matr <- cor(air[correlation.variables])
cor.matr

# Visualize the correlation matrix.
ggcorrplot(cor.matr[,8:1], lab = TRUE)

```
  
  
**b) Se toma la media diaria de cada una de las variables del apartado a) y posteriormente se estudia de nuevo la relación pedida en dicho apartado. ¿Existe alguna diferencia en la relación entre las nuevas variables construídas con los valores medios diarios, con respecto a los resultados obtenidos anteriormente?**  
  
Calculamos la media diaria para las variables y volvemos a visualizar las correlaciones.  

Para O3 las correlaciones con todas las variables meteorológicas y RS se han debilitado.  

Para NO2 las correlaciones se han hecho más fuertes, tanto las positivas como las negativas.  

Para PM10 algunas correlaciones pasan de positivas a negativas, pero siguen siendo débiles.  
    
```{r echo=TRUE, message=FALSE, warning=FALSE}
# Calculate the daily mean for each variable.
air.daily.mean <- aggregate(air, list(air$Fecha), FUN = mean)

# Calculate the correlation matrix for the daily means of the specified variables.
cor.matr.daily.mean <- cor(air.daily.mean[correlation.variables])
cor.matr.daily.mean

# Visualize the correlation matrix.
ggcorrplot(cor.matr.daily.mean[,8:1], lab = TRUE)
```
  
## Modelo de regresión lineal  
**Se quiere explicar el nivel de ozono en función de la radiación solar.**  
  
**a) Estimar por mínimos cuadrados ordinarios un modelo lineal que explique la variable O3 en función de la radiación solar (RS). Se evaluará la bondad del ajuste, a partir del coeficiente de determinación.**  
  
Creamos un modelo que ayude a predecir el nivel de O3 en función de RS.    

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Build model.
regr.model.o3.rs <- lm(O3 ~ RS, data = air)
regr.model.o3.rs

```
La variable RS es significativa para explicar O3 (pvalue < 0.05), así lo podemos ver con el pvalue que obtenemos del summary. El coeficiente 0,059 indica que un aumento de RS en una unidad lleva al aumento de O3 en 0.059 unidades.  


$R^2$ es 0.1382. Se considera que el modelo se ajusta bien a los datos si tenemos un $R^2$ cercano a 1 y el valor que nos ha devuelto el modelo es muy bajo, y la proporción de la varianza explicada por el modelo es baja.   



```{r echo=TRUE, message=FALSE, warning=FALSE}

summary(regr.model.o3.rs)

```


Podemos calcular $R^2$ usando la formula de SCT / SCR, donde SCT es la suma de los cuadrados totales y SCR es la suma de cuardados de los residuos.  

```{r echo=TRUE, message=FALSE, warning=FALSE}

SCT <- sum((air$O3 - mean(air$O3, na.rm = TRUE))^2)

SCR <- sum((regr.model.o3.rs$fitted.values - mean(air$O3))^2)

SCR/SCT
```

Otra forma de calcular $R^2$ es calculando el coeficiente de correlación r y elevando su valor al cuadrado. 

```{r echo=TRUE, message=FALSE, warning=FALSE}
corr.coff <- cor(air$RS, air$O3)
corr.coff^2

```
  
**b) Para calcular el índice de calidad del aire, se establecen diferentes categorías, según sea la concentración de cada contaminante. En este apartado se tomará como contaminante la concentración de PM10 y se establecerán las siguientes categorías, para construir el PM10_cat (Indice de calidad del Aire, en función de PM10):**  
  
Muy buena: valores de (0 a 40],  
Buena: valores de (40 a 60],  
Mejorable: valores de (60 a 120],  
Mala: valores de (120 a 160],  
Muy mala: valores de (160 a 724]  
  
**Se pide, construir un modelo de regresión lineal, tomando como variable dependiente (O3) y la variable explicativa PM10_cat. Interpretar los resultados.**   
  
Creamos una variable categórica para presentar los valores de PM10 como factor.  

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Discretize PM10 variable to PM10_cat.
air$PM10_cat <- ifelse(air$PM10 <= 40, "Muy buena",
       ifelse(air$PM10 <= 60, "Buena",
              ifelse(air$PM10 <= 120, "Mejorable",
                     ifelse(air$PM10 <= 160, "Mala", "Muy mala"))))

# Set it as a factor.
air$PM10_cat <- as.factor(air$PM10_cat)

```

Modificamos los niveles del factor.  

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Set the levels of the factor.
air$PM10_cat <- factor(air$PM10_cat, levels = c("Muy buena", "Buena", "Mejorable", "Mala", "Muy mala"))

```


Creamos el modelo para predecir O3 usando PM10_cat como variable explicativa.  


```{r echo=TRUE, message=FALSE, warning=FALSE}
# Build model with PM10_cat
regr.model.o3.pm10_cat <- lm(O3 ~ PM10_cat, data = air)
regr.model.o3.pm10_cat


```
  
```{r echo=TRUE, message=FALSE, warning=FALSE}
summary(regr.model.o3.pm10_cat)


```
En este modelo todas las variables son significativas, todos los coeficientes son negativos. Los distintos niveles del factor PM10_cat están asociados a la reducción del nivel de O3. Cuando PM10_cat es Muy Mala, entonces la reducción de O3 es mayor que para los otros niveles.  El coeficiente de determinación es 0.442, como significa que el modelo explica un 44.2% de la varianza total.  




## Model de regresión lineal múltiple  
**Se quiere explicar el nivel de ozono en función de la radiación solar (RS),concentración de dióxido de nitrógeno (NO2), temperatura (Tmp) y dirección del aire (Dir_Aire).**
  
**a) Primero, se añadirá al modelo del apartado a), la variable explicativa (Dir_Aire).¿El modelo ha mejorado?**  

Creamos el modelo.  

RS tiene un impacto en O3 porque hace que una subida de RS aumente O3 en 0.044. Dir_aire tiene un impacto negativo, un aumento del valor de esta variable lleva a la reducción de O3.  


```{r echo=TRUE, message=FALSE, warning=FALSE}
# Build model with adding Dir_Aire
regr.model.o3.rs.Dir_Aire <- lm(O3 ~ RS + Dir_Aire, data = air)
regr.model.o3.rs.Dir_Aire


```


Todas las variables son significativas para el modelo, esto podemos verlo por el valor p-value menor que 0,05.  

El valor $R^2$ (0.2446) que tenemos mejora con respecto al apartado a. Introducir la nueva variable Dir_Aire ha hecho que el modelo explique mejor la varianza de los datos.  

```{r echo=TRUE, message=FALSE, warning=FALSE}
# summary of the new model.
summary(regr.model.o3.rs.Dir_Aire)

```
  
**b) Posteriormente se añade al modelo anterior la variable (NO2). ¿Existe una mejora del modelo?**  
  

Añadimos la nueva variable NO2.  
```{r echo=TRUE, message=FALSE, warning=FALSE}
# Build model with adding NO2.
regr.model.o3.rs.Dir_Aire.NO2 <- lm(O3 ~ RS + Dir_Aire + NO2, data = air)
regr.model.o3.rs.Dir_Aire.NO2

```


La variable NO2 tiene un coeficiente negativo, un aumento en esta variable lleva a una reducción de O3. La variable es estadísticamente significativa para el modelo. Con la introducción de NO2 el valor de $R^2$ (0.5812) ha mejorado con respecto a los modelos anteriores, es decir, esta variable ayuda a explicar mejor la varianza de los datos.  


```{r echo=TRUE, message=FALSE, warning=FALSE}
# Summary of new model.
summary(regr.model.o3.rs.Dir_Aire.NO2)


```
  
**c) Se toma la variable (Tmp) y se añade al modelo anterior. Se pide comprobar la presencia o no de colinealidad entre las variables (RS) y (Tmp). Podéis usar la librería (faraway) y estudiar el FIV (factor de inflación de la varianza). Según la conclusión obtenida, discutir si sería indicado o no añadir la variable (Tmp) al modelo. De ser afirmativa la respuesta, construye el modelo e interpreta el resultado.**  
  
Creamos un modelo con la variable adicional Tmp.  

```{r echo=TRUE, message=FALSE, warning=FALSE}

regr.model.o3.rs.Dir_Aire.NO2.Tmp <- lm(O3 ~ RS + Dir_Aire + NO2 + Tmp, data = air)

```

Calculamos el factor de inflación de la varianza que cuantifica la influencia de la colinealidad sobre las predicciones de la regresión. Un valor de vif mayor que 5 puede considerarse preocupante. (  https://daviddalpiaz.github.io/appliedstats/collinearity.html)  

Podemos ver con la función vif que ninguna de las variables tiene valores preocupantes de vif.  


```{r echo=TRUE, message=FALSE, warning=FALSE}
vif(regr.model.o3.rs.Dir_Aire.NO2.Tmp)


```


Con el resumen del modelo podemos ver que $R^2$ ha mejorado algo pero tampoco es muy bueno. La variable Tmp es poco significativa y todas las demás variables si lo son. RS tiene un impacto positivo sobre el nivel O3 y Dir_Aire y NO2 tienen coeficientes negativos: aumentos en valores de estas variables hacen que disminuya O3.  

```{r echo=TRUE, message=FALSE, warning=FALSE}
summary(regr.model.o3.rs.Dir_Aire.NO2.Tmp)


```


## Diagnosis del modelo  
**Para la diagnosis se escoge el modelo construído en el apartado b) y se piden dos gráficos: uno con los valores ajustados frente a los residuos (que nos permitirá ver si la varianza es constante) y el gráfico cuantil-cuantil que compara los residuos del modelo con los valores de una variable que se distribuye normalmente(QQ plot). Interpretar los resultados.**  
  
Mostramos los gráficos para diagnosticar la regresión. 

En primer lugar, el gráfico de valores ajustados vs residuos. Este gráfico no debería mostrar ninguna tendencia, los puntos deberían estar distribuidos de forma aleatoria y simétrica con respecto al valor de residuos igual a cero. 

Podemos ver que sí existe cierta tendencia en la distribución de los residuos. Para valores ajustados bajos solamente hay residuos de valores altos. El modelo incluso predice valores ajustados negativos, algo que no es posible. Para valores de ajustados más altos hay residuos tanto positivos como negativos (algo más de positivos). La línea roja nos ayuda a ver que los residuos no son aleatorios con respecto a 0, donde idealmente la línea roja debería coincidir con 0.  

EN el qqplot parece que la distribución de los residuos se parece a la normal en el tramo medio de la curva y se desvian de la normal sobre los extremos.  

```{r echo=TRUE, message=FALSE, warning=FALSE}

plot(regr.model.o3.rs.Dir_Aire.NO2, which=c(1,2))

```
  
## Predicción del modelo  
**Según el modelo del apartado c), calcular la concentración de O3, si se tienen valores de RS de 180, NO2 de 15, Dir_Aire de 250 grados y Tmp de 20 grados centígrados.**  
  
  
Creamos un data frame con los datos proporcionados en el enunciado y lo usamos para predecir los valores de 03, dadas las demás variables explicativas. 

Con radiación solar de 180, NO2 de 15, dirección del aire de 250 grados y temperatura de 20 grados el modelo estima que el nivel de O3 es de 37.  

```{r echo=TRUE, message=FALSE, warning=FALSE}

new.data <- data.frame(RS=180, Dir_Aire=250, NO2=15, Tmp=20)

pred.multivar.model <- predict(regr.model.o3.rs.Dir_Aire.NO2.Tmp, newdata = new.data)
pred.multivar.model
```
  
# Regresión logística  
**Se quiere estudiar la concentración de O3 del aire de una determinada ciudad. Primero se creará una nueva variable dicotómica llamada icO3 (índice de calidad del aire basado en O3). Se codificará de la siguiente manera:**
  
buena: valores de (0 a 80],  
mejorable: valores de (80 a 100]  
  
**Posteriormente se recodificará como valor 0 la categoría ” buena”. En caso contrario se codificará con el valor 1.  Nota: Dicho índice de calidad se ha recodificado conforme a nuestros datos.**  
  
Codificamos la variable O3 según el enunciado.    
```{r echo=TRUE, message=FALSE, warning=FALSE}
# Discretize variable O3 and save it as icO3.
air$icO3 <- ifelse(air$O3 <= 80, "buena", "mejorable")
# Verify.
head(air %>% select(O3, icO3))
```


## Estudio de relaciones entre variables. Análisis crudo de posibles factores de riesgo  
**a) Se visualiza la relación entre icO3 y las variables independientes: RS, Vel y HR. Para ello se recodificaran las variables RS y Vel, dejando la variable cuantitativa HR, tal como está en la base de datos. Para comprobar si existe asociación entre las variable dependiente y cada una de las variables explicativas, se aplicará el test Chi-cuadrado de Pearson. Un resultado significativo nos dirá que existe asociación. Se procederán a categorizar las variables explicativas de la siguiente forma:**  
  
Radiación solar (RS_cat2):  
normal_baja:(0 a 100],  
normal_alta: valores de (100 a 700]  
  
Velocidad del viento (Vel_cat2):  
flojo: valores de (0 a 3],  
moderado: valores de (3 a 10]  
  
Codificamos las variables RS y Vel según el enunciado.  
```{r echo=TRUE, message=FALSE, warning=FALSE}
# Discretize the variable RS and save it in the variable RS_cat2.
air$RS_cat2 <- ifelse(air$RS <= 100, "normal_baja", "normal_alta")
# Set it as a factor.
air$RS_cat2 <- as.factor(air$RS_cat2)

# Discretize the variable Vel and save it in the variable Vel_cat2.
air$Vel_cat2 <- ifelse(air$Vel <= 3, "flojo", "moderado")
# Set it as a factor.
air$Vel_cat2 <- as.factor(air$Vel_cat2)

# Verify the new variables.
head(air %>% select(RS, RS_cat2, Vel, Vel_cat2))

```


Aplicamos el test chisq.test para comprobar si existe asociación entre la variable ico3 y las variables Vel_cat2 y RS_cat2. El test tiene como hipótesis nula que no existe asociación entre las variables testeadas y para conclir que sí existe asociación tendríamos que rechazar $H_0$. En los dos casos tenemos un p-value por debajo de 0.05 y podemos rechazar la hipótsis nula de que no hay asociación. Las dos variables tienen asociación con ico3.  


Creamos las tablas de contingencia entre la variable icO3 y las variables Vel_cat2 y RS_cat2.  
```{r echo=TRUE, message=FALSE, warning=FALSE}
# Contingency table icO3 vs Vel_cat2.
table.1 <- table(air$icO3, air$Vel_cat2)
table.1

# Contingency table icO3 vs RS_cat2.
table.2 <- table(air$icO3, air$RS_cat2)
table.2
```

```{r echo=TRUE, message=FALSE, warning=FALSE}
chisq.test(table.1)

chisq.test(table.2)
```
  
**b) Posteriormente, para conocer el grado de dicha asociación, se calculará las OR (Odds-Ratio). Importante: Para el cálculo de las OR, se partirá de la tabla de contingencia y se calculará a partir de su fórmula. Debéis implementar dicha fórmula en R. Interpretar las OR calculadas.**  

Tablas de contingencia.  
```{r echo=TRUE, message=FALSE, warning=FALSE}
table.1
table.2


```

El Odds es (probabilidad de que ocurra un suceso) / (probabilidad de que no ocurra)  

Calculamos el odds para la tabla de contingencia de Vel_cat2. Para el viento flojo odds es (88/ (4892+88)) / (4892 / (4892+88)). El resultado de este cálculo será 0.018, significa que cuando el viento es flojo el odds de que el nivel de o3 sea mejorable es 0.018.

El OR es la razón entre los odds para el viento flojo y para el viento moderado y de forma análoga la razón entre los odds para la radiación solar normal_alta y normal_baja. 

Implementamos la formula a continuación. 



```{r echo=TRUE, message=FALSE, warning=FALSE}
# Odd Vel_cat2.
tot.flojo <- table.1[1] + table.1[2]
tot.moderado <- table.1[3] + table.1[4]

odds.flojo <- (table.1[2] / tot.flojo) / (table.1[1] / tot.flojo)
odds.flojo

odds.moderado <- (table.1[4] / tot.moderado) / (table.1[3] / tot.moderado)
odds.moderado
```
```{r}
# OR wind
odds.ratio <- odds.moderado / odds.flojo
odds.ratio

```

El OR es de 1.92. En términos de probabilidad significa que la probabilidad de encontrar ico3 mejorable sobre niveles buenos es mayor cuando el viento es moderado. Es mayor en un 92%. El viento moderado es factor de riesgo para O3, cuando es moderado es más probable que O3 sea mejorable.  
  
Implementamos la formula para RS_cat2.    
```{r echo=TRUE, message=FALSE, warning=FALSE}

tot.normal_alta <- table.2[1] + table.2[2]
tot.normal_baja <- table.2[3] + table.2[4]

odds.normal_alta <- (table.2[2] / tot.normal_alta) / (table.2[1] / tot.normal_alta)
odds.normal_alta

odds.normal_baja <- (table.2[4] / tot.normal_baja) / (table.2[3] / tot.normal_baja)
odds.normal_baja
```

```{r}
# OR solar radiation
odds.ratio2 <-  odds.normal_alta / odds.normal_baja 

odds.ratio2

```
El OR es de 3.1. En términos de probabilidad, encontrar niveles de ico3 mejorables sobre niveles buenos es 3.1 veces más cuando la radiación solar es normal-alta respecto a cuando la radiación solar es normal-baja. 

La radiación solar alta es factor de riesgo para O3.  

  
## Modelo de regresión logística  
**a) Estimad el modelo de regresión logística tomando como variable dependiente icO3 y variable explicativa RS_cat2. Calculad la OR a partir de los resultados del modelo y su intervalo de confianza. ¿Se puede considerar que la radiación solar es un factor de riesgo? Justifica tu respuesta.**

Primero recodificamos la variable dependiente 0 para "buena" y 1 para mejorable.  
```{r echo=TRUE, message=FALSE, warning=FALSE}
# Change "buena" and "mejorable" with 0 and 1.
air$icO3 <- ifelse(test = air$icO3 =="buena", yes = 0, no = 1)

# Verify the new variables.
head(air %>% select(O3, icO3))
```


Creamos el modelo con la variable explicativa RS_cat2.  
  
El coeficiente asociado a RS_cat2 normal_baja es negativo, esto hace que disminuya el valor predicho de icO3 cuando hay un aumento de RS_cat2.Ya que el p-value es menor que 0.05, indica que la variable es significativa para explicar icO3.  
```{r echo=TRUE, message=FALSE, warning=FALSE}
# Build the model.
model.logregr.a <- glm(formula = icO3 ~ RS_cat2, family = binomial(link = logit), data = air)
# Summary of model.
summary(model.logregr.a)

```
Calculamos el Odds Ratio.  
```{r echo=TRUE, message=FALSE, warning=FALSE}

# Odds ratio
exp(coefficients(model.logregr.a))

```
  
Calculamos el intervalo de confianza.    
```{r echo=TRUE, message=FALSE, warning=FALSE}
# Confidence interval.
exp(confint(model.logregr.a))


```
  
El Odds Ratio es la razón entre dos odds: odds de que icO3 sea uno("mejorable") cuando RS_cat2 es alta y odds de que icO3 sea uno("mejorable") cuando RS_cat2 es baja. Un Odds ratio menor que 1 es un factor de protección, el dominador es mayor que el nominador, por lo tanto la probabilidad de que icO3 sea 1 cuando RS_cat2(X) es normal_baja(=0) es mayor que la probabilidad de lo mismo cuando RS_cat2 es normal_alta.  
  
En nuestro caso tenemos un Odds ratio de 0.324, que significa que el suceso de nivel de icO3 mejorable es menos probable en presencia de RS_cat2 normal_baja.
  
El intervalo de confianza es de 0.234 a 0.445, significa que con un nivel de confianza de 95% afirma que odds radio está en ese rango.    


**b) Se crea un nuevo modelo con la misma variable dependiente y se añade al apartado a) la variable TMP. Interpretar si nos encontramos o no ante una posible variable de confusión.**  
  
Creamos el nuevo modelo.  
```{r echo=TRUE, message=FALSE, warning=FALSE}
# Build the model.
model.logregr.b <- glm(formula = icO3 ~ RS_cat2 + Tmp, family = binomial(link = logit), data = air)
# Summary of model.
summary(model.logregr.b)


```
  
El coeficiente de RS_cat2 ha cambiado al introducir la nueva variable de -1.1267 a -0.78954 (un aumento de cerca de 40%), así que podemos considerar que la variable Tmp es una variable de confusión. Una variable de confusión es la variable que está relacionada con el factor de interés y también con la variable dependiente.


```{r echo=TRUE, message=FALSE, warning=FALSE}
# Create a new column RS_cat2_bin binary values of RS_cat2.
air$RS_cat2_bin <- ifelse(test = air$RS_cat2 =="normal_baja", yes = 0, no = 1)
# Set it to factor.
air$RS_cat2_bin <- as.factor(air$RS_cat2_bin)

```


```{r echo=TRUE, message=FALSE, warning=FALSE}
# Verify Tmp related to icO3
logist1 <- glm(formula = icO3 ~ Tmp, family = binomial(link = logit), data = air)
# Summary of model.
summary(logist1)
# Verify Tmp related to RS_cat2.
logist2 <- glm(formula = RS_cat2_bin ~ Tmp, family = binomial(link = logit), data = air)
summary(logist2)
```

Arriba hemos creados dos modelos para comprobar si la variable nueva introducida es significativa para explicar icO3 y también para explicar si esta variable es significativa para explicar el factor de interés RS_cat2. Hemos encontrado que en ambos casos Tmp es significativa para explicar icO3 y RS_cat2, y esto confirma que el Tmp es una variable de confusión.


**c) Se añade al modelo del apartado a) la variable HR. Estudiar la existencia o no de interacción entre las variables explicativas RS_cat2 y HR. Interpretar.**  
  
Creamos el nuevo model con las variables explicativas RS_cat2 y HR.  Los coeficientes de las variable RS_cat2 normal_baja y Hr ambos son negativos, con un aumento de qualquiera de las variables explicativas disminuya la probabilidad de icO3 mejorable. Las dos variable explicativas son signigicativas para el modelo (pvalue<0.05).

Con la introducción de HR hemos visto un cambio del valor del coeficiente para RS_cat2normal_baja.    

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Build the model.
model.logregr.c <- glm(formula = icO3 ~ RS_cat2 + HR, family = binomial(link = logit), data = air)
# Summary of model.
summary(model.logregr.c)


```
  
Creamos un modelo para comprobar la interacción entre las variables.  

Existe interacción cuando la asociación entre la variable respuesta y el factor de interés varía según los distintos niveles de otra variable explicativa.  

Al introducir la variable que representa la interacción RS_cat2:HR, una de las variables que teníamos en el modelo (HR) deja de ser significativa. La interacción entre RS_cat2 y HR es estadísticamente significativa, así lo indica el valor pvalue.  


```{r echo=TRUE, message=FALSE, warning=FALSE}
# Build the model.
model.interac <- glm(formula = icO3 ~ RS_cat2 + HR + RS_cat2:HR, family = binomial(link = logit), data = air)
# Summary of model.
summary(model.interac)

```
  
Representamos el logit del modelo, frente a la humedad HR según la variable RS.  
  
Observamos que las rectas no son paralelas que significa que la variable HR modifica el efecto del factor RS y tenemos una interacción.    


```{r echo=TRUE, message=FALSE, warning=FALSE}
# Visualize the interaction.
predict1=predict(model.interac,type="link")
plot(air$HR,predict1,type="n",main=" interaccion")
points(air$HR[air$RS_cat2=="normal_baja"],predict1[air$RS_cat2=="normal_baja"],col=2)
points(air$HR[air$RS_cat2=="normal_alta"],predict1[air$RS_cat2=="normal_alta"],col=4)


```
  
**d) Se crea un nuevo modelo con las variables explicativas RS_cat2 y Dir_Aire. ¿Existe una mejora del modelo?**  
  
  
Creamos un nuevo modelo usando las variables explicativas indicadas en el enunciado. 

En el modelo todos los coeficientes son negativos, un aumento en cualquiera de las variables lleva a que disminuya la probabilidad de que ocurra ico3 = 1. Las variables que hemos usado son significativas para predecir icO3.  
```{r echo=TRUE, message=FALSE, warning=FALSE}
# Build the model.
model.logregr.d <- glm(formula = icO3 ~ RS_cat2 + Dir_Aire, family = binomial(link = logit), data = air)
# Summary of model.
summary(model.logregr.d)


```



Podemos evaluar que el modelo ha mejorado usando AIC, el criterio de información de Akaike. Se considera mejor el modelo si al introducir una variable nueva el valor de AIC disminuye. En este modelo obtenemos el valor de AIC es de 1410.9, el más bajo entre todos los modelos que hemos creado hasta ahora.  
  

## Predicción  
  
**Según el modelo del apartado d), calculad la probabilidad de que la concentración de O3 sea o no superior a 80, con unos valores de RS_cat2=“Normal_alta”y Dir_Aire=40.**  
  
  
Usamos el modelo del apartado d para hacer la predicción con los datos nuevos. La probabilidad de que ocurra que el valor de O3 sea mayor que 80 es de 7.7% dados los valores que hemos pasado para predecir (RS_cat2 normal_alta y Dir_Aire = 40).

Si la radiación solar es normal- alta y la dirección del aire es 40, entonces la probabilidad de que el valor de O3 sea mayor que 80 es de 7.7%.  
```{r echo=TRUE, message=FALSE, warning=FALSE}
new.data2 <- data.frame(RS_cat2=as.factor("normal_alta"), Dir_Aire=40)

predictor3 <- predict(object = model.logregr.d, new.data2, type = "response")
predictor3
```

  
## Bondad del ajuste  
  
**Usa el test de Hosman-Lemeshow para ver la bondad de ajuste, tomando el modelo del apartado d). En la librería ResourceSelection hay una función que ajusta el test de Hosmer- Lemeshow.**  
  
Cuando el modelo tiene una variable explicativa continua tenemos que usar el test de Hosman-Lemeshow.  
  
Ejecutamos el test y tenemos un p-value menor de 0.05 que significa el rechazo de hipótesis nula, indicaría que el modelo **NO** está bien ajustado.  
```{r echo=TRUE, message=FALSE, warning=FALSE}
hoslem.test(air$icO3, fitted(model.logregr.d))


```
  
## Curva ROC  
**Dibujar la curva ROC, y calcular el área debajo de la curva con el modelo del apartado d). Discutir el resultado.**  
  
  
Visualizamos la curva ROC con el modelo del apartado d.  
  
La curva ROC muestra la sensibilidad frente a la especificidad. La sensibilidad es la proporción de verdaderos positivos entre el total de positivos (verdaderos y falsos). La especificidad es la proporción de verdaderos negativos entre todos los negativos (verdaderos y falsos). Idealmente la sensibilidad y la especificidad son altas  y esto se ve en la curva ROC como una linea vertical que sale de especificidad=0 y alcanza el valor de sensitividad=1. Esto da lugar al área baja la curva más grande posible.  
  
Nuestro modelo no cumple con el área máxima, más abajo calculamos el AUROC que es 0.78 que es adecuanda.    
```{r echo=TRUE, message=FALSE, warning=FALSE}
# Plot ROC
prob=predict(model.logregr.d, air, type="response")
r=roc(air$icO3,prob, data=air)
plot(r)


```
  
Calulamos el área debajo de la curva ROC.    
```{r echo=TRUE, message=FALSE, warning=FALSE}
# Calculate area under curve.
auc(r)

```
  
# Conclusiones del análisis  


En esta PEC hemos trabajado con regresiones lineales y logísticas. 

Para los modelos de regresión es importante que no existan correlaciones entre las variables, por lo tanto, a lo largo de la pec estaremos comprobando su existencia. 

**Regresiones lineales.**

Creamos una regresión para predecir O3 con RS como variable explicativa. En este caso R2 (0.14) indica que RS explica poca variabilidad de O3. RS es significativa y un aumento en su valor implica un aumento de =3 en 0.06.  

Por otra parte creamos una regresión para explicar O3 a partir de PM10_cat y vemos ejecutando summary del modelo que R2 es mucho mejor, pero todavía explica poca variabilidad de O3 (0.44).La variable PM10_cat es significativa y sus coeficientes indican que cuanto mayor su valor, más se reduce O3.  

La regresión que explica O3 usando como variables explicativas RS y Dir_Aire tiene un R2 de 0.24. Este valor ha mejorado con respecto a la regresión con solamente RS, pero tampoco es un buen modelo para explicar el comportamiento de O3. 

Añadimos una nueva variable (NO2) a la regresión anterior y con ella obtenemos un mejor valor para el coeficiente de determinación (0.5812), así añadir NO2 a las variables anteriores ha ayudado a explicar mejor el comportamiento de O3. Los residuos que resultan de este modelo no están distribuidos de forma uniforme con respecto a 0. Cuando los valores predichos son bajos, los residuos suelen ser positivos y hay un mayor número de residuos negativos para valores predichos medios. En valores predichos altos los residuos otra vez son más a menudo positivos que negativos.   


Finalmente añadimos la variable Tmp a todas las variables que usamos anteriormente. Con esta adición R2 ha aumentado muy poco, esta variable no ha aportado mucho a explicar O3 y también es poco significativa. 


**Regresiones logísticas.**   

Los test para comprobar la asociación entre variables nos han dado como resultado que sí existe asociación entre la variable O3 y las variables Vel_cat2 y RS_cat2 y para conocer el grado de asociación usamos el OR. Los OR para Vel_cat2 y RS_cat2 son 1.92 y 3.1 respectivamente. Podemos interpretarlo: el viento moderado es factor de riesgo para los niveles de O3 y en su presencia es más probable que O3 sea mejorable. De la misma forma la radiación solar normal-alta es factor de riesgo para los niveles de O3, en su presencia es más probable que ocurran niveles mejorables de O3.  

En la primera regresión logística usamos la variable RS_cat2 para explicar icO3. Esta variable es significativa para el modelo, un aumento en una unidad de esta variable implica una reducción de 1.12 de icO3. El OR para esta variable indica que la radiación solar baja es factor de protección (OR=0.32) y que en su presencia es menos probable que ocurran niveles mejorables de icO3.  

En el siguiente modelo añadimos la variable Tmp que resulta ser significativa y con coeficiente positivo. Esta variable ha introducido confusión en el modelo y podemos ver esto a partir del coeficiente para la variable RS_cat2normal_baja que sufre una variación de más del 40%. Comprobamos que en efecto la variable Tmp además de estar relacionada con icO3, también lo está con RS_cat2.  

Otra regresión logística considera como variables explicativas RS_cat2 y HR, ambas resultan significativas para explicar la probabilidad de icO3 mejorable y tienen el efecto de reducción de la probabilidad de icO3 mejorable por sus coeficientes negativos. Vemos que existe interacción entre RS_cat2 y HR.  

Por último, usamos como explicativas RS_cat2 y Dir_Aire. Ambas son significativas y el valor de AIC indica que el modelo ha mejorado con respecto a la regresión donde solamente usamos RS_cat2. Sin embargo, vemos que el test Hosman-Lemeshow nos da como resultado que la bondad de ajuste del modelo es mala. Por otra parte, la curva ROC y el área bajo la curva auroc indican que el modelo discrimina de forma adecuada.  